<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portfólio Multi-API Seguro</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial; background: #f4f4f4; padding: 20px; }
h1, h2 { text-align: center; }
.container { display:flex; flex-wrap:wrap; justify-content:center; gap:20px; }
.card { background:#fff; padding:20px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.1); width:250px; text-align:center; }
.price { font-size:1.5em; margin:10px 0; }
.change { font-weight:bold; }
.positive { color:green; }
.negative { color:red; }
table { width:100%; border-collapse:collapse; margin-top:20px; }
th, td { padding:8px 12px; border:1px solid #ccc; text-align:center; }
th { background:#eee; }
.chart-container { width:100%; max-width:600px; margin:20px auto; }
</style>
</head>
<body>

<h1>Portfólio Multi-API Seguro</h1>

<h2>Ações</h2>
<div class="container" id="stocksContainer"></div>

<h2>FIIs</h2>
<div class="container" id="fiisContainer"></div>

<h2>Detalhes</h2>
<table id="portfolioTable">
<thead>
<tr><th>Ativo</th><th>Preço</th><th>Variação</th><th>Tipo</th></tr>
</thead>
<tbody></tbody>
</table>

<div class="chart-container">
<canvas id="priceChart"></canvas>
</div>

<script>
const apiKeys = {
    alphaVantage: 'FED4M5E51XUFQBLO',
    hgBrasil: '66b9d746',
    brapi: '', // opcional
    twelveData: '', // opcional
    marketstack: '' // opcional
};

const tickers = [
    { type:'stock', symbol:'AAPL' },
    { type:'stock', symbol:'MSFT' },
    { type:'fii', symbol:'KNRI11' },
    { type:'fii', symbol:'HGLG11' }
];

// Funções seguras para cada API
async function fetchAlphaVantage(symbol){
    try {
        const res = await fetch(`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${apiKeys.alphaVantage}`);
        const data = await res.json();
        const quote = data['Global Quote'];
        if(!quote || !quote['05. price']) return null;
        return {
            price: parseFloat(quote['05. price']),
            change: parseFloat(quote['10. change percent']?.replace('%','')) || 0
        };
    } catch { return null; }
}

async function fetchHgBrasil(symbol){
    try {
        const res = await fetch(`https://api.hgbrasil.com/finance/stock_price?key=${apiKeys.hgBrasil}&symbol=${symbol}`);
        const data = await res.json();
        const result = data.results ? data.results[symbol] : null;
        if(!result) return null;
        return {
            price: parseFloat(result.price),
            change: parseFloat(result.change_percent) || 0
        };
    } catch { return null; }
}

async function fetchBrapi(symbol){
    if(!apiKeys.brapi) return null;
    try {
        const res = await fetch(`https://brapi.dev/api/quote/${symbol}`);
        const data = await res.json();
        if(!data.results || !data.results[0]) return null;
        return {
            price: parseFloat(data.results[0].regularMarketPrice),
            change: parseFloat(data.results[0].regularMarketChangePercent) || 0
        };
    } catch { return null; }
}

async function fetchTwelveData(symbol){
    if(!apiKeys.twelveData) return null;
    try {
        const res = await fetch(`https://api.twelvedata.com/price?symbol=${symbol}&apikey=${apiKeys.twelveData}`);
        const data = await res.json();
        if(!data.price) return null;
        return { price: parseFloat(data.price), change: 0 }; // change precisa endpoint adicional
    } catch { return null; }
}

async function fetchMarketstack(symbol){
    if(!apiKeys.marketstack) return null;
    try {
        const res = await fetch(`https://api.marketstack.com/v1/eod?symbols=${symbol}&access_key=${apiKeys.marketstack}`);
        const data = await res.json();
        if(!data.data || !data.data[0]) return null;
        const close = parseFloat(data.data[0].close);
        const open = parseFloat(data.data[0].open);
        const change = ((close - open)/open * 100) || 0;
        return { price: close, change };
    } catch { return null; }
}

// Atualiza o portfólio
async function updatePortfolio(){
    const stocksContainer = document.getElementById('stocksContainer');
    const fiisContainer = document.getElementById('fiisContainer');
    const tableBody = document.querySelector('#portfolioTable tbody');
    stocksContainer.innerHTML = ''; fiisContainer.innerHTML = ''; tableBody.innerHTML = '';
    let chartLabels = [], chartData = [];

    for(const ticker of tickers){
        // Tenta múltiplas APIs em ordem
        const data = await fetchAlphaVantage(ticker.symbol) 
                  || await fetchHgBrasil(ticker.symbol)
                  || await fetchBrapi(ticker.symbol)
                  || await fetchTwelveData(ticker.symbol)
                  || await fetchMarketstack(ticker.symbol);

        if(!data) continue;

        chartLabels.push(ticker.symbol); chartData.push(data.price);

        const cardHtml = `<div class="card"><h2>${ticker.symbol}</h2>
                          <div class="price">R$ ${data.price.toFixed(2)}</div>
                          <div class="change ${data.change>=0?'positive':'negative'}">${data.change>=0?'+':''}${data.change.toFixed(2)}%</div></div>`;
        if(ticker.type==='stock') stocksContainer.innerHTML += cardHtml;
        else fiisContainer.innerHTML += cardHtml;

        tableBody.innerHTML += `<tr><td>${ticker.symbol}</td>
                                <td>R$ ${data.price.toFixed(2)}</td>
                                <td class="${data.change>=0?'positive':'negative'}">${data.change.toFixed(2)}%</td>
                                <td>${ticker.type.toUpperCase()}</td></tr>`;
    }

    renderChart(chartLabels, chartData);
}

// Renderiza gráfico
let chart;
function renderChart(labels,data){
    const ctx = document.getElementById('priceChart').getContext('2d');
    if(chart) chart.destroy();
    chart = new Chart(ctx,{
        type:'bar',
        data:{ labels, datasets:[{ label:'Preço (R$)', data, backgroundColor:data.map(d=>'rgba(0,128,0,0.6)'), borderColor:'green', borderWidth:1 }] },
        options:{ responsive:true, scales:{ y:{ beginAtZero:false } } }
    });
}

// Inicializa
updatePortfolio();
setInterval(updatePortfolio,300000); // 5 minutos
</script>
</body>
</html>
