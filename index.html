<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portfólio Multi-API</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial; background: #f4f4f4; padding: 20px; }
h1, h2 { text-align: center; }
.container { display:flex; flex-wrap:wrap; justify-content:center; gap:20px; }
.card { background:#fff; padding:20px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.1); width:250px; text-align:center; }
.price { font-size:1.5em; margin:10px 0; }
.change { font-weight:bold; }
.positive { color:green; }
.negative { color:red; }
table { width:100%; border-collapse:collapse; margin-top:20px; }
th, td { padding:8px 12px; border:1px solid #ccc; text-align:center; }
th { background:#eee; }
.chart-container { width:100%; max-width:600px; margin:20px auto; }
</style>
</head>
<body>

<h1>Portfólio Multi-API</h1>

<h2>Ações</h2>
<div class="container" id="stocksContainer"></div>

<h2>FIIs</h2>
<div class="container" id="fiisContainer"></div>

<h2>Detalhes</h2>
<table id="portfolioTable">
<thead>
<tr><th>Ativo</th><th>Preço</th><th>Variação</th><th>Tipo</th></tr>
</thead>
<tbody></tbody>
</table>

<div class="chart-container">
<canvas id="priceChart"></canvas>
</div>

<script>
const apiKeys = {
    alphaVantage: 'FED4M5E51XUFQBLO',
    hgBrasil: '66b9d746',
    brapi: 'SUA_BAPI_KEY_AQUI',
    twelveData: 'SUA_TWELVE_DATA_KEY_AQUI',
    marketstack: 'SUA_MARKETSTACK_KEY_AQUI'
};

const tickers = [
    { type:'stock', symbol:'AAPL' },
    { type:'stock', symbol:'MSFT' },
    { type:'fii', symbol:'KNRI11' },
    { type:'fii', symbol:'HGLG11' }
];

// Funções para cada API
async function fetchAlphaVantage(symbol){
    const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${apiKeys.alphaVantage}`;
    const res = await fetch(url); const data = await res.json();
    if(data['Global Quote']) return { price: parseFloat(data['05. price']), change: parseFloat(data['10. change percent']) };
}

async function fetchHgBrasil(symbol){
    const url = `https://api.hgbrasil.com/finance/stock_price?key=${apiKeys.hgBrasil}&symbol=${symbol}`;
    const res = await fetch(url); const data = await res.json();
    if(data.results && data.results[symbol]) return { price: parseFloat(data.results[symbol].price), change: parseFloat(data.results[symbol].change_percent) };
}

async function fetchBrapi(symbol){
    const url = `https://brapi.dev/api/quote/${symbol}`;
    const res = await fetch(url); const data = await res.json();
    if(data.results && data.results[0]) return { price: parseFloat(data.results[0].regularMarketPrice), change: parseFloat(data.results[0].regularMarketChangePercent) };
}

async function fetchTwelveData(symbol){
    const url = `https://api.twelvedata.com/price?symbol=${symbol}&apikey=${apiKeys.twelveData}`;
    const res = await fetch(url); const data = await res.json();
    if(data.price) return { price: parseFloat(data.price), change: 0 }; // TwelveData precisa de endpoint adicional para variação
}

async function fetchMarketstack(symbol){
    const url = `https://api.marketstack.com/v1/eod?symbols=${symbol}&access_key=${apiKeys.marketstack}`;
    const res = await fetch(url); const data = await res.json();
    if(data.data && data.data[0]) return { price: parseFloat(data.data[0].close), change: 0 }; // Marketstack precisa calcular variação
}

// Função principal
async function updatePortfolio(){
    const stocksContainer = document.getElementById('stocksContainer');
    const fiisContainer = document.getElementById('fiisContainer');
    const tableBody = document.querySelector('#portfolioTable tbody');

    stocksContainer.innerHTML = ''; fiisContainer.innerHTML = ''; tableBody.innerHTML = '';
    let chartLabels=[], chartData=[];

    for(const ticker of tickers){
        let data;
        // Tenta múltiplas APIs em ordem de prioridade
        data = await fetchAlphaVantage(ticker.symbol) || await fetchHgBrasil(ticker.symbol) || await fetchBrapi(ticker.symbol) || await fetchTwelveData(ticker.symbol) || await fetchMarketstack(ticker.symbol);
        if(!data) continue;

        chartLabels.push(ticker.symbol); chartData.push(data.price);

        const cardHtml = `<div class="card"><h2>${ticker.symbol}</h2><div class="price">R$ ${data.price.toFixed(2)}</div><div class="change ${data.change>=0?'positive':'negative'}">${data.change>=0?'+':''}${data.change}%</div></div>`;
        if(ticker.type==='stock') stocksContainer.innerHTML += cardHtml;
        else fiisContainer.innerHTML += cardHtml;

        tableBody.innerHTML += `<tr><td>${ticker.symbol}</td><td>R$ ${data.price.toFixed(2)}</td><td class="${data.change>=0?'positive':'negative'}">${data.change}%</td><td>${ticker.type.toUpperCase()}</td></tr>`;
    }

    renderChart(chartLabels, chartData);
}

let chart;
function renderChart(labels,data){
    const ctx = document.getElementById('priceChart').getContext('2d');
    if(chart) chart.destroy();
    chart = new Chart(ctx,{
        type:'bar',
        data:{ labels:labels, datasets:[{ label:'Preço (R$)', data:data, backgroundColor:data.map(d=>'rgba(0,128,0,0.6)'), borderColor:'green', borderWidth:1 }] },
        options:{ responsive:true, scales:{ y:{ beginAtZero:false } } }
    });
}

updatePortfolio();
setInterval(updatePortfolio,300000);

</script>
</body>
</html>
