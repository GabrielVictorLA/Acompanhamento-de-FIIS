<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FIIs - Tempo Real</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial, sans-serif; background:#f8f9fa; padding:20px; }
.header { background:#2c3e50; color:white; padding:20px; border-radius:10px; text-align:center; }
.badge-status { margin:2px; padding:6px 10px; border-radius:6px; }
.chart-container { background:white; border-radius:10px; padding:15px; margin-bottom:20px; }
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h2>📊 FIIs em Tempo Real</h2>
        <div id="apiStatus">
            <span class="badge-status bg-secondary">Alpha Vantage</span>
            <span class="badge-status bg-secondary">HG Brasil</span>
        </div>
        <p id="lastUpdate">Última atualização: -</p>
        <button class="btn btn-warning mt-2" onclick="fetchData()">🔄 Atualizar Agora</button>
    </div>

    <table class="table table-striped mt-3">
        <thead><tr><th>Ticker</th><th>Preço</th><th>Variação</th><th>Fonte</th></tr></thead>
        <tbody id="fiiTableBody"><tr><td colspan="4">Carregando...</td></tr></tbody>
    </table>

    <div id="charts"></div>
</div>

<script>
const config = {
    alphaVantageKey: "FED4M5E51XUFQBLO",
    hgBrasilKey: "66b9d746"
};
const tickers = ["GARE11","CACR11","KNCR11","SNEL11","XPML11"];
const fiis = {}; tickers.forEach(t => fiis[t] = {price:"vazio", variation:"vazio", source:"-"});
const proxies = ["https://corsproxy.io/?","https://api.allorigins.win/raw?url="];
const charts = {}; const chartData = {}; tickers.forEach(t=>chartData[t]={labels:[],values:[]});

function setApiStatus(api, ok) {
    const span = document.querySelector(`#apiStatus span:nth-child(${api==="alpha"?1:2})`);
    span.className = "badge-status " + (ok?"bg-success":"bg-danger");
    span.textContent = (api==="alpha"?"Alpha Vantage":"HG Brasil") + (ok?" ✅":" ❌");
}
async function fetchWithProxies(url) {
    for (let proxy of proxies) {
        try {
            const res = await fetch(proxy+encodeURIComponent(url));
            if (res.ok) return await res.json();
        } catch {}
    }
    throw new Error("Falha em todos os proxies");
}
async function fetchHGBrasil() {
    try {
        const url = `https://api.hgbrasil.com/finance/stock_price?key=${config.hgBrasilKey}&symbol=${tickers.join(",")}`;
        const data = await fetchWithProxies(url);
        let ok=0;
        tickers.forEach(t=>{
            if(data.results && data.results[t] && data.results[t].price){
                fiis[t].price=data.results[t].price;
                fiis[t].variation=data.results[t].change_percent;
                fiis[t].source="HG Brasil"; ok++;
            }
        });
        setApiStatus("hg",ok>0);
    } catch{ setApiStatus("hg",false); }
}
async function fetchAlphaVantage() {
    let ok=0;
    for(const t of tickers){
        try{
            const url=`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${t}.SA&apikey=${config.alphaVantageKey}`;
            const data=await fetchWithProxies(url);
            const q=data["Global Quote"];
            if(q && q["05. price"]){
                fiis[t].price=parseFloat(q["05. price"]);
                fiis[t].variation=parseFloat(q["10. change percent"]);
                fiis[t].source="Alpha Vantage"; ok++;
            }
        }catch{}
        await new Promise(r=>setTimeout(r,12000));
    }
    setApiStatus("alpha",ok>0);
}
function updateTable(){
    let html="";
    tickers.forEach(t=>{
        html+=`<tr><td>${t}</td><td>${typeof fiis[t].price==="number"?fiis[t].price.toFixed(2):"vazio"}</td><td>${fiis[t].variation||"vazio"}</td><td>${fiis[t].source}</td></tr>`;
    });
    document.getElementById("fiiTableBody").innerHTML=html;
    document.getElementById("lastUpdate").textContent="Última atualização: "+new Date().toLocaleTimeString("pt-BR");
}
function createCharts(){
    const container=document.getElementById("charts");
    tickers.forEach(t=>{
        const div=document.createElement("div");
        div.className="chart-container";
        div.innerHTML=`<h5>${t}</h5><canvas id="chart-${t}"></canvas>`;
        container.appendChild(div);
        charts[t]=new Chart(document.getElementById(`chart-${t}`),{type:"line",data:{labels:[],datasets:[{label:"Preço",data:[],borderColor:"#007bff"}]}});
    });
}
function updateCharts(){
    const now=new Date().toLocaleTimeString("pt-BR");
    tickers.forEach(t=>{
        if(typeof fiis[t].price==="number"){
            chartData[t].labels.push(now);
            chartData[t].values.push(fiis[t].price);
            if(chartData[t].labels.length>20){chartData[t].labels.shift();chartData[t].values.shift();}
            charts[t].data.labels=chartData[t].labels;
            charts[t].data.datasets[0].data=chartData[t].values;
            charts[t].update();
        }
    });
}
async function fetchData(){
    await Promise.all([fetchHGBrasil(),fetchAlphaVantage()]);
    updateTable(); updateCharts();
}
document.addEventListener("DOMContentLoaded",()=>{createCharts();fetchData();});
</script>
</body>
</html>
