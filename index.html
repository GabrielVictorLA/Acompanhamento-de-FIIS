// Função para buscar dados da HG Brasil
async function fetchHGBrasilData() {
    const tickers = Object.keys(fiis).join(',');
    const url = `https://api.hgbrasil.com/finance/stock_price?key=${config.hgBrasilKey}&symbol=${tickers}`;
    
    try {
        const response = await fetch(url);
        const data = await response.json();
        for (const ticker of Object.keys(fiis)) {
            const info = data.results && data.results[ticker] ? data.results[ticker] : null;
            if (info && info.price) {
                fiis[ticker].priceHG = info.price;
                fiis[ticker].variationHG = info.change_percent || 0;
                fiis[ticker].volumeHG = info.volume || 0;
            } else {
                fiis[ticker].priceHG = "vazio";
                fiis[ticker].variationHG = "vazio";
                fiis[ticker].volumeHG = "vazio";
            }
        }
        updateTable();
    } catch (error) {
        console.error('Erro HG Brasil:', error);
        elements.hgStatus.classList.remove('status-active');
        elements.hgStatus.classList.add('status-inactive');
        elements.hgStatusText.textContent = 'Erro';
        elements.hgStatusText.classList.replace('bg-success','bg-danger');
    }
}

// Função para buscar dados da Alpha Vantage
async function fetchAlphaVantageData() {
    const tickersList = Object.keys(fiis);
    for (const ticker of tickersList) {
        const symbol = `${ticker}.SA`;
        const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${config.alphaVantageKey}`;
        try {
            const response = await fetch(url);
            const data = await response.json();
            if (data['Global Quote'] && data['Global Quote']['05. price']) {
                const quote = data['Global Quote'];
                fiis[ticker].priceAV = parseFloat(quote['05. price']);
                fiis[ticker].variationAV = parseFloat(quote['10. change percent'].replace('%','')) || 0;
                fiis[ticker].volumeAV = parseInt(quote['06. volume']) || 0;
            } else {
                fiis[ticker].priceAV = "vazio";
                fiis[ticker].variationAV = "vazio";
                fiis[ticker].volumeAV = "vazio";
            }
        } catch (error) {
            console.error(`Erro Alpha Vantage para ${ticker}:`, error);
            elements.alphaStatus.classList.remove('status-active');
            elements.alphaStatus.classList.add('status-inactive');
            elements.alphaStatusText.textContent = 'Erro';
            elements.alphaStatusText.classList.replace('bg-success','bg-danger');
        }
        // Limitar requisições para não ultrapassar o limite da Alpha Vantage
        await new Promise(resolve => setTimeout(resolve, 12000));
    }
    updateTable();
}

// Função de atualização da tabela usando ambos os dados
function updateTable() {
    let tableHTML = '';
    for (const [ticker, data] of Object.entries(fiis)) {
        const price = data.priceHG !== "vazio" ? data.priceHG : data.priceAV;
        const variation = data.variationHG !== "vazio" ? data.variationHG : data.variationAV;
        const volume = data.volumeHG !== "vazio" ? data.volumeHG : data.volumeAV;
        const variationClass = typeof variation === 'number' ? (variation >= 0 ? 'positive':'negative') : 'neutral';
        const variationDisplay = typeof variation === 'number' ? (variation >=0 ? '▲ '+variation.toFixed(2)+'%' : '▼ '+Math.abs(variation).toFixed(2)+'%') : 'vazio';
        const priceDisplay = typeof price === 'number' ? formatCurrency(price) : 'vazio';
        const volumeDisplay = typeof volume === 'number' ? formatVolume(volume) : 'vazio';
        const dyDisplay = typeof data.dy === 'number' ? formatPercent(data.dy) : 'vazio';
        const pvpDisplay = typeof data.pvp === 'number' ? data.pvp.toFixed(2) : 'vazio';
        const lastIncomeDisplay = typeof data.lastIncome === 'number' ? formatCurrency(data.lastIncome) : 'vazio';
        const sourceDisplay = data.priceHG !== "vazio" ? 'HG Brasil' : (data.priceAV !== "vazio" ? 'Alpha Vantage' : 'vazio');

        tableHTML += `
            <tr>
                <td><strong>${ticker}</strong></td>
                <td>${priceDisplay}</td>
                <td class="${variationClass}">${variationDisplay}</td>
                <td>${dyDisplay}</td>
                <td>${pvpDisplay}</td>
                <td>${lastIncomeDisplay}</td>
                <td>${volumeDisplay}</td>
                <td><span class="badge bg-info">${sourceDisplay}</span></td>
            </tr>
        `;
    }
    elements.fiiTableBody.innerHTML = tableHTML;
    const now = new Date();
    elements.lastUpdate.textContent = `Última atualização: ${now.toLocaleTimeString('pt-BR')}`;
    elements.summaryUpdate.textContent = now.toLocaleString('pt-BR');
}

// Função principal para buscar dados de ambas as APIs
async function fetchData() {
    elements.connectionStatus.innerHTML = '<i class="fas fa-sync-alt spinning"></i> Conectando às APIs...';
    await Promise.all([fetchHGBrasilData(), fetchAlphaVantageData()]);
    elements.connectionStatus.innerHTML = '<i class="fas fa-wifi"></i> Conectado às APIs';
}
